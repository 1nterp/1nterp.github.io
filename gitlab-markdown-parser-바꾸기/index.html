<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Gitlab Markdown Parser 바꾸기 &#183; InterP Ink</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title="InterP Ink"></head><body><nav class=nav><div class=nav-container><a href=/><h2 class=nav-title>InterP Ink</h2></a><ul></ul></div></nav><main><div class=post><div class=post-info><time datetime="2018-01-03 02:29:21 +0000 UTC">2018년 1월 3일</time></div><h1 class=post-title>Gitlab Markdown Parser 바꾸기</h1><div class=post-line></div><p>Git 기반 프로세스 도구인 <a href=https://about.gitlab.com/>Gitlab</a> 은 오픈소스이기 때문에 Community Edition 을 쓰건, Enterprise Edition 을 쓰건 상관없이 맘대로 수정해서 사용이 가능하다. 물론 적절한 감(?)으로 수정할 곳을 찾아야 하는 번거로움은 있다. 여기서는 Gitlab에서 문서 작성에 필요한 Markdown 의 Parser 부분을 수정하기 위한 방법을 정리해 둔다. Ruby 개발자가 아니라서 전체 빌드 순서가 정공법처럼 보이진 않겠지만.</p><p>Gitlab의 Markdown Parser는 <a href=https://github.com/vmg/redcarpet>Redcarpet</a> 을 사용한다. 아마 <a href=https://jekyllrb-ko.github.io/>Jekyll</a> 도 기본적으로 Redcarpet 을 사용하는 것으로 알고 있다. 만약 Ruby의 Redcarpet 을 Markdown Parser 로 쓰는 경우라면 똑같이 적용이 가능하다.</p><p>디렉토리 경로는 Gitlab 10.x 기준으로 설명한다.</p><h3 id=parser-c-파일-수정하기>Parser C 파일 수정하기</h3><p><code>/opt/gitlab/embedded/lib/ruby/gems/2.3.0/gems/redcarpet-3.4.0/</code> 으로 들어가면 Redcarpet의 소스코드가 존재한다. 여기서 <code>ext/redcarpet</code> 디렉토리가 Parser C 파일들이 위치한 곳이다.</p><p>내가 수정하고 싶은 것은 ‘<strong>엔터 키를 두번 쳐야 (혹은 줄 끝에 스페이스를 2개 이상 줘야) 줄바꿈이 되는 불편함</strong>‘ 을 해소하고 싶었다. <code>markdown.c</code> 파일을 보니 <code>char_linebreak()</code>  라는 함수가 존재한다. 여기서 해당 부분을 주석처리했다.</p><h3 id=라이브러리-생성복사>라이브러리 생성/복사</h3><p>수정이 끝나면 반드시 <code>ext/redcarpet</code> 디렉토리에서 <code>make</code> 를 수행해 주도록 하자. 그러면 Shared Library 파일인 <code>redcarpet.so</code> 이 생성된다.</p><p>이 파일을, 다음 경로에 모두 복사해주도록 하자.</p><ul><li><code>/opt/gitlab/embedded/lib/ruby/gems/2.3.0/extensions/x86_64-linux/2.3.0/redcarpet-3.4.0/</code></li><li><code>/opt/gitlab/embedded/lib/ruby/gems/2.3.0/gems/redcarpet-3.4.0/lib/</code></li></ul><h3 id=gitlab-재부팅>Gitlab 재부팅</h3><p>대망의 재부팅이 남았다.</p><p><code>gitlab-ctl reconfigure && gitlab-ctl restart</code> 를 실행시키면 반영이 된다!</p><p> </p><h3 id=gitlab-11x-이후--commonmark>Gitlab 11.x 이후 : Commonmark</h3><p>11.x 부터는 Redcarpet 이 아니라 Commonmark 를 기본 파서로 사용한다. 구조가 달라져서 찾는게 귀찮아서 그렇지, 기본 원리는 비슷하다. 2칸 이상의 space 를 준 채로 줄바꿈하게 되면 <code>CMARK_NODE_LINEBREAK</code>, 그렇지 않고 줄바꿈하면 <code>CMARK_NODE_SOFTBREAK</code> 상태로 전이된다.</p><p>옵션을 쓸 수 있다면 좋겠지만, 본인은 마음이 급한지라 참고할 만한 소스코드만 붙이고 도망가도록 한다. <code>html.c:283</code> 부터다. 여기서 직접 line break 를 하도록 강제했다.</p><p>이렇게 하고 make 를 치면.. 어? 빌드가 안 된다.</p><p>당황하지 말고, 보기 싫지만 banzai filter 가 위치한 곳의 ruby 파일을 수정하면 된다. 여기에서 사실 옵션 조절이 가능하다. 파일 위치는 <code>/opt/gitlab/embedded/service/gitlab-rails/lib/banzai/filter/markdown_engines/common_mark.rb</code> 이다.</p><p>반드시, Gitlab 재부팅을 잊지말자!</p><p>한 가지 아쉬운 점은(?) 일부러 soft break 를 시도하는 경우에, 내부에서 line break 까지 겹쳐서 인식하기 때문에 결론적으로 <code>&lt;br/></code> 이 두번 붙는 사태가 일어난다. 어쩔 수 없이 commonmark 를 한번 빌드하는 수밖에 없나.. 하는 생각이 들고 있다.</p></div><div class=pagination><a href=/oh-zsh-%EC%83%89%EA%B9%94-%EA%B3%A0%EB%A5%B4%EA%B8%B0/ class="left arrow">&#8592;</a>
<a href=/%EB%8C%80%ED%99%94%EB%8A%94-%ED%95%84%EC%9A%94%ED%95%B4/ class="right arrow">&#8594;</a>
<a href=# class=top>Top</a></div></main><footer><span>&copy; <time datetime="2020-02-04 13:05:11.826952718 +0000 UTC m=+0.224176031">2020</time> InterP. 이 사이트는 <a href=https://gohugo.io>Hugo</a> 로 작성되었으며 <a href=https://github.com/EmielH/tale-hugo/>Tale</a> 테마를 사용합니다!</span></footer></body></html>